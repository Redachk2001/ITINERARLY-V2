import Foundation
import CoreLocation
import MapKit

class EnhancedLocationService: ObservableObject {
    
    // MARK: - Public Methods
    
    func enhanceLocation(_ location: Location, completion: @escaping (Location) -> Void) {
        // Cr√©er une copie pour modification
        var enhancedLocation = location
        
        // 1. Am√©liorer l'adresse avec g√©ocodage inverse
        enhanceAddress(location: enhancedLocation) { address in
            enhancedLocation = enhancedLocation.withUpdatedAddress(address)
            
            // 2. D√©terminer le type d'activit√© pr√©cis
            let activityType = self.determineActivityType(from: enhancedLocation)
            enhancedLocation = enhancedLocation.withUpdatedDescription(activityType)
            
            // 3. Calculer la dur√©e recommand√©e
            let recommendedDuration = self.calculateRecommendedDuration(for: enhancedLocation)
            enhancedLocation = enhancedLocation.withUpdatedRecommendedDuration(recommendedDuration)
            
            // 4. G√©n√©rer des conseils de visite
            let visitTips = self.generateVisitTips(for: enhancedLocation)
            enhancedLocation = enhancedLocation.withUpdatedVisitTips(visitTips)
            
            completion(enhancedLocation)
        }
    }
    
    // MARK: - Address Enhancement
    
    private func enhanceAddress(location: Location, completion: @escaping (String) -> Void) {
        let coordinate = CLLocationCoordinate2D(latitude: location.latitude, longitude: location.longitude)
        let clLocation = CLLocation(latitude: coordinate.latitude, longitude: coordinate.longitude)
        
        let geocoder = CLGeocoder()
        geocoder.reverseGeocodeLocation(clLocation) { placemarks, error in
            DispatchQueue.main.async {
                if let placemark = placemarks?.first {
                    let enhancedAddress = self.buildCompleteAddress(from: placemark)
                    completion(enhancedAddress)
                } else {
                    // Fallback vers l'adresse existante
                    completion(location.address)
                }
            }
        }
    }
    
    private func buildCompleteAddress(from placemark: CLPlacemark) -> String {
        var addressComponents: [String] = []
        
        if let thoroughfare = placemark.thoroughfare {
            addressComponents.append(thoroughfare)
        }
        
        if let subThoroughfare = placemark.subThoroughfare {
            addressComponents.append(subThoroughfare)
        }
        
        if let locality = placemark.locality {
            addressComponents.append(locality)
        }
        
        if let postalCode = placemark.postalCode {
            addressComponents.append(postalCode)
        }
        
        if let country = placemark.country {
            addressComponents.append(country)
        }
        
        return addressComponents.joined(separator: ", ")
    }
    
    // MARK: - Activity Type Determination
    
    private func determineActivityType(from location: Location) -> String {
        let name = location.name.lowercased()
        let category = location.category
        
        // R√®gles sp√©cifiques bas√©es sur le nom et la cat√©gorie
        switch category {
        case .restaurant:
            if name.contains("pizza") || name.contains("pizzeria") {
                return "üçï Pizzeria - Restaurant italien"
            } else if name.contains("sushi") || name.contains("japonais") {
                return "üç£ Restaurant japonais"
            } else if name.contains("burger") || name.contains("fast") {
                return "üçî Fast-food / Burger"
            } else if name.contains("caf√©") || name.contains("cafe") {
                return "‚òï Caf√©-Restaurant"
            } else {
                return "üçΩÔ∏è Restaurant gastronomique"
            }
            
        case .cafe:
            if name.contains("boulangerie") || name.contains("patisserie") {
                return "ü•ê Boulangerie-P√¢tisserie"
            } else if name.contains("glace") || name.contains("ice cream") {
                return "üç¶ Glacier"
            } else {
                return "‚òï Caf√©"
            }
            
        case .bar:
            if name.contains("pub") || name.contains("irish") {
                return "üç∫ Pub irlandais"
            } else if name.contains("cocktail") || name.contains("mixology") {
                return "üç∏ Bar √† cocktails"
            } else {
                return "üç∫ Bar"
            }
            
        case .museum:
            if name.contains("art") || name.contains("contemporain") {
                return "üé® Mus√©e d'art contemporain"
            } else if name.contains("histoire") || name.contains("historique") {
                return "üèõÔ∏è Mus√©e d'histoire"
            } else if name.contains("science") || name.contains("technique") {
                return "üî¨ Mus√©e des sciences"
            } else {
                return "üèõÔ∏è Mus√©e"
            }
            
        case .nature:
            if name.contains("jardin") || name.contains("botanique") {
                return "üå∫ Jardin botanique"
            } else if name.contains("for√™t") || name.contains("bois") {
                return "üå≤ Parc forestier"
            } else {
                return "üå≥ Parc public"
            }
            
        case .shopping:
            if name.contains("centre") || name.contains("mall") {
                return "üõçÔ∏è Centre commercial"
            } else if name.contains("boutique") || name.contains("magasin") {
                return "üëï Boutique"
            } else {
                return "üõí Centre commercial"
            }
            
        case .swimmingPool:
            return "üèä Piscine"
            
        case .climbingGym:
            return "üßó Salle d'escalade"
            
        case .bowling:
            return "üé≥ Bowling"
            
        case .laserTag:
            return "üéØ Laser Game"
            
        case .escapeRoom:
            return "üîê Salle d'√©vasion"
            
        case .paintball:
            return "üé® Paintball"
            
        case .karting:
            return "üèéÔ∏è Karting"
            
        case .miniGolf:
            return "‚õ≥ Mini-golf"
            
        case .trampolinePark:
            return "ü§∏ Parc de trampolines"
            
        case .adventurePark:
            return "üåø Parc d'aventure"
            
        case .zoo:
            return "ü¶Å Zoo"
            
        case .aquarium:
            return "üê† Aquarium"
            
        case .waterPark:
            return "üåä Parc aquatique"
            
        case .iceRink:
            return "‚õ∏Ô∏è Patinoire"
            
        case .entertainment:
            return "üé™ Divertissement"
            
        case .historical:
            return "üèõÔ∏è Site historique"
            
        case .religious:
            return "‚õ™ Lieu de culte"
            
        case .culture:
            return "üé≠ Centre culturel"
            
        case .sport:
            return "üèÉ Centre sportif"
            
        default:
            return "üìç Lieu d'int√©r√™t"
        }
    }
    
    // MARK: - Duration Calculation
    
    private func calculateRecommendedDuration(for location: Location) -> TimeInterval {
        let category = location.category
        let name = location.name.lowercased()
        
        // Dur√©es de base par cat√©gorie (en minutes)
        let baseDuration: TimeInterval
        
        switch category {
        case .restaurant:
            if name.contains("fast") || name.contains("burger") {
                baseDuration = 30 // 30 minutes pour fast-food
            } else {
                baseDuration = 90 // 1h30 pour restaurant
            }
            
        case .cafe:
            if name.contains("boulangerie") || name.contains("patisserie") {
                baseDuration = 20 // 20 minutes pour boulangerie
            } else {
                baseDuration = 45 // 45 minutes pour caf√©
            }
            
        case .bar:
            baseDuration = 60 // 1 heure pour bar
            
        case .museum:
            if name.contains("art") || name.contains("contemporain") {
                baseDuration = 120 // 2 heures pour mus√©e d'art
            } else {
                baseDuration = 90 // 1h30 pour autres mus√©es
            }
            
        case .nature:
            if name.contains("jardin") || name.contains("botanique") {
                baseDuration = 60 // 1 heure pour jardin
            } else {
                baseDuration = 45 // 45 minutes pour parc
            }
            
        case .shopping:
            if name.contains("centre") || name.contains("mall") {
                baseDuration = 180 // 3 heures pour centre commercial
            } else {
                baseDuration = 60 // 1 heure pour boutique
            }
            
        case .swimmingPool:
            baseDuration = 120 // 2 heures pour piscine
            
        case .climbingGym:
            baseDuration = 150 // 2h30 pour escalade
            
        case .bowling:
            baseDuration = 90 // 1h30 pour bowling
            
        case .laserTag:
            baseDuration = 60 // 1 heure pour laser game
            
        case .escapeRoom:
            baseDuration = 75 // 1h15 pour escape room
            
        case .paintball:
            baseDuration = 180 // 3 heures pour paintball
            
        case .karting:
            baseDuration = 60 // 1 heure pour karting
            
        case .miniGolf:
            baseDuration = 45 // 45 minutes pour mini-golf
            
        case .trampolinePark:
            baseDuration = 90 // 1h30 pour trampoline
            
        case .adventurePark:
            baseDuration = 240 // 4 heures pour parc d'aventure
            
        case .zoo:
            baseDuration = 180 // 3 heures pour zoo
            
        case .aquarium:
            baseDuration = 120 // 2 heures pour aquarium
            
        case .waterPark:
            baseDuration = 240 // 4 heures pour parc aquatique
            
        case .iceRink:
            baseDuration = 90 // 1h30 pour patinoire
            
        case .entertainment:
            baseDuration = 120 // 2 heures pour divertissement
            
        case .historical:
            baseDuration = 60 // 1 heure pour site historique
            
        case .religious:
            baseDuration = 30 // 30 minutes pour lieu de culte
            
        case .culture:
            baseDuration = 90 // 1h30 pour centre culturel
            
        case .sport:
            baseDuration = 120 // 2 heures pour centre sportif
            
        default:
            baseDuration = 60 // 1 heure par d√©faut
        }
        
        return baseDuration * 60 // Convertir en secondes
    }
    
    // MARK: - Visit Tips Generation
    
    private func generateVisitTips(for location: Location) -> [String] {
        let category = location.category
        let name = location.name.lowercased()
        var tips: [String] = []
        
        switch category {
        case .restaurant:
            tips.append("R√©servez √† l'avance pour √©viter l'attente")
            tips.append("V√©rifiez les horaires d'ouverture")
            if name.contains("pizza") {
                tips.append("Essayez leurs pizzas maison")
            }
            
        case .cafe:
            tips.append("Parfait pour une pause d√©tente")
            if name.contains("boulangerie") {
                tips.append("D√©gustez leurs viennoiseries fra√Æches")
            }
            
        case .museum:
            tips.append("V√©rifiez les expositions temporaires")
            tips.append("Prenez votre temps pour appr√©cier les ≈ìuvres")
            
        case .nature:
            tips.append("Id√©al pour une promenade relaxante")
            tips.append("Profitez de la nature et du calme")
            
        case .swimmingPool:
            tips.append("Apportez votre maillot et serviette")
            tips.append("V√©rifiez les horaires de cours")
            
        case .climbingGym:
            tips.append("√âquipement disponible sur place")
            tips.append("Cours pour d√©butants disponibles")
            
        case .bowling:
            tips.append("R√©servation recommand√©e le weekend")
            tips.append("Chaussures fournies sur place")
            
        case .laserTag:
            tips.append("√âquipement fourni sur place")
            tips.append("Parfait pour un groupe d'amis")
            
        case .escapeRoom:
            tips.append("R√©servation obligatoire")
            tips.append("√âquipe de 2-6 personnes recommand√©e")
            
        case .shopping:
            if name.contains("centre") {
                tips.append("Planifiez votre visite")
                tips.append("Parking disponible")
            }
            
        case .culture:
            tips.append("V√©rifiez la programmation")
            tips.append("R√©servation recommand√©e")
            
        case .sport:
            tips.append("√âquipement disponible")
            tips.append("Cours pour tous niveaux")
            
        default:
            tips.append("Profitez de votre visite !")
        }
        
        return tips
    }
}

// MARK: - Location Extensions

extension Location {
    func withUpdatedAddress(_ newAddress: String) -> Location {
        return Location(
            id: self.id,
            name: self.name,
            address: newAddress,
            latitude: self.latitude,
            longitude: self.longitude,
            category: self.category,
            description: self.description,
            imageURL: self.imageURL,
            rating: self.rating,
            openingHours: self.openingHours,
            recommendedDuration: self.recommendedDuration,
            visitTips: self.visitTips
        )
    }
    
    func withUpdatedDescription(_ newDescription: String) -> Location {
        return Location(
            id: self.id,
            name: self.name,
            address: self.address,
            latitude: self.latitude,
            longitude: self.longitude,
            category: self.category,
            description: newDescription,
            imageURL: self.imageURL,
            rating: self.rating,
            openingHours: self.openingHours,
            recommendedDuration: self.recommendedDuration,
            visitTips: self.visitTips
        )
    }
    
    func withUpdatedRecommendedDuration(_ newDuration: TimeInterval) -> Location {
        return Location(
            id: self.id,
            name: self.name,
            address: self.address,
            latitude: self.latitude,
            longitude: self.longitude,
            category: self.category,
            description: self.description,
            imageURL: self.imageURL,
            rating: self.rating,
            openingHours: self.openingHours,
            recommendedDuration: newDuration,
            visitTips: self.visitTips
        )
    }
    
    func withUpdatedVisitTips(_ newTips: [String]) -> Location {
        return Location(
            id: self.id,
            name: self.name,
            address: self.address,
            latitude: self.latitude,
            longitude: self.longitude,
            category: self.category,
            description: self.description,
            imageURL: self.imageURL,
            rating: self.rating,
            openingHours: self.openingHours,
            recommendedDuration: self.recommendedDuration,
            visitTips: newTips
        )
    }
} 